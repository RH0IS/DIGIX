<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'coinmarketapp/styles.css' %}">
    <title>DIGIX - Coin Market Application</title>
</head>
<body>
    <header>
       <a href="{% url 'demo' %}">
            <div class="logo">
                <img src="{% static 'coinmarketapp/logo.png' %}" alt="CoinMarketApp">
            </div>
       </a>
        <nav>
            <ul>
                <li><a href="/home">Home</a></li>
                <li><a href="#">Cryptocurrencies</a></li>
                <li><a href="/exchange">Exchanges</a></li>
                <li><a href="#">Markets</a></li>
            </ul>
        </nav>
    </header>


     <div class="wrapper">
      <header>Currency Converter</header>
      <form action="#">
        <div class="amount">
          <p>Enter Amount</p>
          <input type="text" value="1">
        </div>
        <div class="drop-list">
          <div class="from">
            <p>From</p>
            <div class="select-box">
              <!-- Set default "From" currency as USD -->
              <select id="fromCurrency">
                <option value="USD" selected>USD</option>
              </select>
            </div>
          </div>
          <div class="icon"><i class="fas fa-exchange-alt"></i></div>
          <div class="to">
            <p>To</p>
            <div class="select-box">
              <select id="toCurrency">
                <!-- Iterate through cryptocurrency names and create options -->
                {% for currency_name in name %}
                  <option value="{{ currency_name }}">{{ currency_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="exchange-rate">Getting exchange rate...</div>
        <button id="getExchangeRate">Get Exchange Rate</button>
      </form>
    </div>
    <br><br><br>

  <script>
    const fromCurrency = document.getElementById("fromCurrency");
    const toCurrency = document.getElementById("toCurrency");
    const getExchangeRateButton = document.getElementById("getExchangeRate");
    const exchangeRateTxt = document.querySelector(".exchange-rate");

    const apiKey = "1400ea97-a782-4685-81f3-d9ad1ef83928";
    const coinMarketCapUrl = `https://pro-api.coinmarketcap.com/v1/cryptocurrency/listings/latest?CMC_PRO_API_KEY=${apiKey}`;

    let exchangeRates = {}; // Added this line to define the exchangeRates variable

    // Fetch currency names from CoinMarketCap API
    fetch(coinMarketCapUrl, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })

    .then(data => {
        const coinNames = data.data.map(currency => ({
            name: currency.name,
            symbol: currency.symbol,
        }));

        // Populate select options with currency names
        const toCurrencySelect = document.getElementById("toCurrency");
        coinNames.forEach(currency => {
            const optionTag = `<option value="${currency.symbol}">${currency.name}</option>`;
            toCurrencySelect.insertAdjacentHTML("beforeend", optionTag);
        });

        // Set "From" currency to USD
        const fromCurrencySelect = document.getElementById("fromCurrency");
        const usdOptionTag = '<option value="USD">USD</option>';
        fromCurrencySelect.insertAdjacentHTML("beforeend", usdOptionTag);

        // Trigger change event to initialize selectedCrypto variable
        fromCurrencySelect.dispatchEvent(new Event("change"));
    })
    .catch(error => {
        console.error('Error fetching currency names: ', error);
    });

    // Fetch exchange rates from ExchangeRate API
    function fetchExchangeRates() {
        const exchangeRateUrl = "https://v6.exchangerate-api.com/v6/3ba44afda43062f9ffa4fa5a/latest/USD";

        fetch(exchangeRateUrl)
            .then(response => response.json())
            .then(data => {
                exchangeRates = data.conversion_rates; // Updated this line to assign the fetched rates to exchangeRates
                const selectedFromCurrency = fromCurrency.value;
                const selectedToCurrency = toCurrency.value;
                const initialExchangeRate = exchangeRates[selectedToCurrency] / exchangeRates[selectedFromCurrency];
                exchangeRateTxt.innerText = `1 ${selectedFromCurrency} = ${initialExchangeRate} ${selectedToCurrency}`;
            })
            .catch(error => {
                console.error('Error fetching exchange rates: ', error);
                exchangeRateTxt.innerText = "Exchange rate not available";
            });
    }

    toCurrency.addEventListener("change", () => {
        const selectedToCurrency = toCurrency.value;
        const selectedFromCurrency = fromCurrency.value;
        const exchangeRate = exchangeRates[selectedToCurrency] / exchangeRates[selectedFromCurrency];
        exchangeRateTxt.innerText = `1 ${selectedFromCurrency} = ${exchangeRate} ${selectedToCurrency}`;
    });

    getExchangeRateButton.addEventListener("click", (e) => {
        e.preventDefault();
        getExchangeRate();
    });

    function getExchangeRate() {
        const amount = document.querySelector("form input");
        const fromCurrencyValue = document.getElementById("fromCurrency").value; // Use the selected cryptocurrency
        const toCurrencyValue = toCurrency.value;

        exchangeRateTxt.innerText = "Getting exchange rate...";

        // Fetch exchange rate from ExchangeRate API
        const exchangeRateUrl = `https://v6.exchangerate-api.com/v6/3ba44afda43062f9ffa4fa5a/latest/${fromCurrencyValue}`;

        fetch(exchangeRateUrl)
            .then(response => response.json())
            .then(result => {
                const exchangeRate = result.conversion_rates[toCurrencyValue];
                const totalExRate = (amount.value * exchangeRate).toFixed(2);
                exchangeRateTxt.innerText = `${amount.value} ${fromCurrencyValue} = ${totalExRate} ${toCurrencyValue}`;
            })
            .catch(() => {
                exchangeRateTxt.innerText = "Something went wrong";
            });
    }

    window.addEventListener("load", () => {
        fetchExchangeRates();
        getExchangeRate();
    });
</script>





    <footer>
        <p>&copy; 2023 DIGIX - All Rights Reserved</p>
    </footer>
</body>
</html>
