<!-- exchange.html -->

<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{% static 'coinmarketapp/styles.css' %}">
    <title>DIGIX - Coin Market Application</title>
</head>
<body>
    <header>
        <a href="{% url 'demo' %}">
            <div class="logo">
                <img src="{% static 'coinmarketapp/logo.png' %}" alt="CoinMarketApp">
            </div>
        </a>
        <nav>
            <ul>
                <li><a href="/home">Home</a></li>
                <li><a href="#">Cryptocurrencies</a></li>
                <li><a href="/exchange">Exchanges</a></li>
                <li><a href="#">Markets</a></li>
            </ul>
        </nav>
    </header>

    <div class="wrapper">
        <header>Currency Converter</header>
        <form action="#">
            <div class="amount">
                <p>Enter Amount</p>
                <input type="text" value="1">
            </div>
            <div class="drop-list">
                <div class="from">
                    <p>From</p>
                    <div class="select-box">
                        <select id="fromCurrency">
                            {% for crypto in cryptocurrencies %}
                                <option value="{{ crypto.symbol }}">{{ crypto.name }} ({{ crypto.symbol }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="icon"><i class="fas fa-exchange-alt"></i></div>
                <div class="to">
                    <p>To</p>
                    <div class="select-box">
                        <select id="toCurrency">
                            <option value="USD" selected>USD</option>
                        </select>
                    </div>
                </div>
            </div>


            <div class="exchange-rate" id="exchangeRate">Getting exchange rate...</div>
            <div id="currencyInfo"></div>
            <button id="getExchangeRate">Get Exchange Rate</button>
        </form>
    </div>

    <script>
        const fromCurrency = document.getElementById("fromCurrency");
        const toCurrency = document.getElementById("toCurrency");

        const getExchangeRateButton = document.getElementById("getExchangeRate");
     const exchangeRateTxt = document.getElementById("exchangeRate");
        const currencyInfoDiv = document.getElementById("currencyInfo");
        let exchangeRates = {};

        // Fetch exchange rates from ExchangeRate API
        function fetchExchangeRates() {
    const exchangeRateUrl = "/get_exchange_rates/";

    console.log('Fetching exchange rates...');
    console.log('API URL:', exchangeRateUrl);

    fetch(exchangeRateUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok, status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API Response:', data);

            const currencies = data.data.map(crypto => ({
                symbol: crypto.symbol,
                name: crypto.name,
                price: crypto.quote.USD.price,
            }));

            console.log("Currencies:", currencies);

            exchangeRates = currencies.reduce((acc, crypto) => {
                acc[crypto.symbol] = crypto.price;
                return acc;
            }, {});

            console.log("Exchange Rates:", exchangeRates);

            // Set "From" currency options dynamically
                const fromCurrencySelect = document.getElementById("fromCurrency");
                currencies.forEach(crypto => {
                    const optionTag = `<option value="${crypto.symbol}">${crypto.name} (${crypto.symbol})</option>`;
                    fromCurrencySelect.insertAdjacentHTML("beforeend", optionTag);
                });

            // Trigger change event to initialize selectedCrypto variable
            fromCurrencySelect.dispatchEvent(new Event("change"));

            exchangeRateTxt.innerText = "Exchange rates loaded.";
        })
        .catch(error => {
            console.error('Error fetching exchange rates: ', error);
            exchangeRateTxt.innerText = "Error fetching exchange rates. See console for details.";
        });
}

// Call the fetchExchangeRates function when the page loads
window.addEventListener("load", fetchExchangeRates);



        toCurrency.addEventListener("change", () => {
            const selectedToCurrency = toCurrency.value;
            const selectedFromCurrency = fromCurrency.value;
            const exchangeRate = exchangeRates[selectedToCurrency] !== undefined && exchangeRates[selectedFromCurrency] !== undefined
                ? exchangeRates[selectedToCurrency] / exchangeRates[selectedFromCurrency]
                : 0;

            exchangeRateTxt.innerText = `1 ${selectedFromCurrency} = ${exchangeRate} ${selectedToCurrency}`;
        });

        getExchangeRateButton.addEventListener("click", (e) => {
            e.preventDefault();
            getExchangeRate();
        });

       function getExchangeRate() {
    const amount = document.querySelector("form input");
    const fromCurrencyValue = document.getElementById("fromCurrency").value;
    const toCurrencyValue = document.getElementById("toCurrency").value; // Updated to get the selected value of "toCurrency" dropdown

    exchangeRateTxt.innerText = "Getting exchange rate...";

    // Check if exchange rates are available
    if (Object.keys(exchangeRates).length > 0) {
        // Check if exchange rates are available for both currencies
        if (exchangeRates[fromCurrencyValue] !== undefined && exchangeRates[toCurrencyValue] !== undefined) {
            // Calculate the exchange rate based on selected currencies
            const exchangeRate = exchangeRates[toCurrencyValue] / exchangeRates[fromCurrencyValue];

            // Display the exchange rate
            exchangeRateTxt.innerText = `1 ${fromCurrencyValue} = ${exchangeRate} ${toCurrencyValue}`;

            // Display currency information (replace with actual data)
            displayCurrencyInfo(fromCurrencyValue, toCurrencyValue);
        } else {
            exchangeRateTxt.innerText = "Exchange rates not available for the selected currencies.";
        }
    } else {
        exchangeRateTxt.innerText = "Exchange rates are still loading. Please wait.";
    }
}

function displayCurrencyInfo(fromCurrency, toCurrency, fromCurrencyInfo, toCurrencyInfo) {
            // Display currency information
            currencyInfoDiv.innerHTML = `
                <p>${fromCurrency}:</p>
                <p>Name: ${fromCurrencyInfo.name}</p>
                <p>Symbol: ${fromCurrencyInfo.symbol}</p>
                <p>Price: ${exchangeRates[fromCurrency].toFixed(2)}</p>
                <br>
                <p>${toCurrency}:</p>
                <p>Name: ${toCurrencyInfo.name}</p>
                <p>Symbol: ${toCurrencyInfo.symbol}</p>
                <p>Price: ${exchangeRates[toCurrency].toFixed(2)}</p>
            `;
        }

        window.addEventListener("load", () => {
            fetchExchangeRates();
            getExchangeRate();
        });
    </script>

    <footer>
        <p>&copy; 2023 DIGIX - All Rights Reserved</p>
    </footer>
</body>
</html>
